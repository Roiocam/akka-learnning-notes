# Akka 消息投递一般原则

    投递 = 交付 = Deliver(v.)

## 1. 交付语义

| 语义 | 含义(发送给交付机制的消息) | 性能 | 原理 |
| ------ | ------ |------ |------ |
| **最多一次** | 只会投递一次或者不投递。`消息可能丢失` | 性能高,开销低 | 即发即忘 <br>  发送端：不维护状态 <br> 接收端：不维护状状态|
| **最少一次** | 可能会被多次投递，这样至少又一个是成功交付的。`消息可能重复但不会丢失` | 中等 | <br>  发送端：维护状态，实现重试机制 <br> 接收端：实现确认机制 |
| **精确一次** | 对于接收者只会投递一次。`消息不会丢失不会重复` | 低性能,高开销 |  发送端：维护状态，实现重试机制 <br> 接收端：维护状态过滤重复交付，实现确认机制|

## 2. 一般原则

在 Akka 中消息投递遵循以下原则：

- **最多一次交付 At Most Once**，不保证交付。
- **保证每个发送者-接收者之间消息有序**，不保证多个发送者-接收者有序

## 3. Akka 为什么不对消息的投递做保证 ？

可靠交付在分布式世界中不是一件低成本的事情。Akka 作为框架提供者在两个层面上决定不默认提供消息的可靠交付。

1. 对于发送方，消息投递是否成功的唯一有意义的方式是接收到来自接收方在业务级别上确认消息。Akka 作为框架，不希望强制用户照本宣科以 Akka 开发者的思维去实现业务级别的确认消息。
2. 在基本保证之上实现可靠交付容易，但是将可靠交付的消息投递移除则是一件困难的事情。 `例如 最少一次 -> 最多一次`

## 4. Akka 消息排序的保证

Akka 对消息的有序的保证的，主要是以下三点：

1. 对于点对点之间的消息，Akka 保证有序。`B 接收到 A 发来的消息顺序，总是和 A 发往 B 的消息顺序一致` 
2. 对于多个发送者之间，Akka 不保证有序。
   1. `A 发送消息 M1 到 B 和 C。`
   2. `B 接收到 M1 后转发给 C。`
   3. `C 端接收的消息顺序，可能是 B(M1), A(M1)`
3. 用户的消息和系统级别的消息之间不保证有序。
   1. `子 Actor A，发送消息 M 给 父 Actor B`
   2. `子 Actor 因故障死亡, 其死亡事件 F 被发送给父 Actor `
   3. `在父 Actor 中，M，F 的消息顺序不一定是按时间顺序 (M,F) 接收，可能是 (F,M)`
   
## 5. 可靠交付保证

### 这个主题的关键点在与这个"保证"着什么

1. 消息是否在网络中传输
2. 消息是否被其他主机接收
3. 消息是否被放入了目标 Actor 的消息邮箱
4. 消息是否被目标 Actor 开始处理
5. 消息是否被目标 Actor 成功处理

每一个点都是一个挑战，也就是说每一个流程都可能出现问题。

### 至少一次和精确一次

精确一次交付是一个理想的结果，但是在消息通信中几乎是不可能的。在 Akka 中的消息通信可以抽象为计算机网络中的通信。["两军问题"](https://en.wikipedia.org/wiki/Two_Generals%27_Problem) 同样存在于 Akka 消息通信世界中。

因此，退而求其次使用至少一次的消息交付，在收益上更为客观。

### 实现至少一次交付的策略

对于消息投递，我们的直觉是推送形式，即消息生产者主动向消息消费者发送消息。但是消息投递的方式可以有两种形式：

- 推送(push)形式： 生产者主动将消息推送给消费者
- 拉取(poll)形式： 消费者从生产者拉取消息

这两种投递方式实现至少一次交付的责任承担着不同，因而实现至少一次交付的方式也需要有两种。

#### a. 至少推送一次消息

通信过程中，消息可能在投递中途丢失，在推送方式中，消息生产者需要承担消息丢失的责任。除此之外，未确认的消息的可能因系统重启而导致丢失，因而第二件事则是需要对待确认消息实现持久化策略。

所以推送方式的至少一次交付可以总结为以下两点：

1. 消息投递重试机制
2. 持久化待确认消息列表

![push-at-least-once.png](/img/push-at-least-once.png)

#### b. 至少拉取一次消息

在拉取方式的消息投递中，消息传输的过程被颠倒了。消费者需要承担从生产者检索消息的主要责任。这意味着对于上述至少一次交付中的重试和持久化的责任者不同。

1. **消息生产者**：`负责持久化待发送消息列表`
2. **消息消费者**：`负责拉取消息的偏移量，负责拉取的重试机制`

![poll-at-least-once.png](/img/poll-at-least-once.png)

# 最后

本章以简短的语言介绍了 Akka 对于消息投递的一般保证，什么是可靠交付，如何实现可靠交付。在 Akka 中，除了一般原则之外，还提供了可靠交付的工具用于实现至少一次性交付，将在下文介绍。
