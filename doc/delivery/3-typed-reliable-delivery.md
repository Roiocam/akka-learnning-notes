# Typed 可靠交付通用原则

在经典 Actor 实现了推送方式的至少一次交付，但是 Akka 开发者认为推送的方式并不友好，因而在 Typed 中使用的是工作拉取的方式实现可靠交付。

## 1. 特性

Typed 的可靠交付中，有三种实现分别对应着不同的使用场景:

1. 点对点模式: 单个生产者和消费者，支持对大消息分块
2. 工作拉取模式: 多个生产者和多个消费者
3. 分片模式: 生产者和集群分片消费者之间的可靠交付

它们的使用方式，基本原理相同，都是由两个 Controller 在内部封装消息的可靠交付。

由于消息的交付的重试机制被 Controller 封装，所以在不崩溃的情况下， Typed 的可靠交付可以实现精确一次交付语义。也正是因为这种实现方式，所以强制 Actor 和 Controller 必须存在于同一 JVM 下。

## 2. 交付语义

1. 当生产者和消费者都没有崩溃时，精确一次。
2. 当生产者崩溃时, 至少一次，
3. 当消费者崩溃时，至少一次。

## 3. 时序图

![typed-p2p.png](/img/typed-p2p.png)

## 4. 案例

可靠交付的作者在 Typed 中工作拉取式的可靠交付中，识别出可靠交付的场景主要有三种：

- [**点对点模式**](/doc/delivery/4-typed-reliable-delivery-p2p.md)：即一对一，两个 Actor 之间的消息投递实现可靠性，一般是生产者消费者模型。
- [**工作拉取模式**](/doc/delivery/5-typed-reliable-delivery-pull.md)：即一对多，多个消费者 Actor 同时向一个生产者请求投递消息。
- [**分片模式**](/doc/delivery/6-typed-reliable-delivery-sharding.md)：即多对多，如一个生产者向分片中的多个消费者投递消息；多个生产者分别向固定的分片 Actor 发送消息。